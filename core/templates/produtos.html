{% extends 'cab.html' %}
{% load static %}

{% block content %}

<style>
.titulo-estoque {
    margin-top: 15px;
    margin-bottom: 25px;
    text-align: center;
    font-size: 2rem;
    font-weight: bold;
    letter-spacing: 1px;
    font-family: 'Segoe UI', Arial, sans-serif;
    color: #d4af37;
}

/* GRID DE PRODUTOS */
.produtos-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 16px;
    margin-bottom: 2.5rem;
}

/* CARD */
.produto-card {
    width: 100%;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background: #111;
    color: #f5f5f5;
    border-radius: 10px;
    padding: 12px;
    min-height: 140px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.3s ease;
    border: 1px solid transparent;
    box-sizing: border-box;
    overflow: hidden;
}
.produto-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.5);
    border: 1px solid #d4af37;
}

/* IMAGEM */
.produto-img {
    width: 90px;
    height: 90px;
    object-fit: cover;
    border-radius: 8px;
    flex-shrink: 0;
}

/* TEXTO */
.produto-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
    overflow: hidden;
}
.produto-info h5 {
    font-size: 1rem;
    font-weight: bold;
    margin: 0 0 6px;
    color: #ffd700;
    white-space: normal;
    word-wrap: break-word;
}
.info-item {
    display: flex;
    flex-direction: column;
}
.info-item .label {
    font-size: 0.7rem;
    color: #aaa;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.info-item .value {
    font-size: 0.9rem;
    color: #f5f5f5;
    font-weight: 500;
}

/* RESPONSIVO */
@media (max-width: 1400px) {
    .produtos-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
}
@media (max-width: 992px) {
    .produtos-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 600px) {
    .produtos-grid { grid-template-columns: 1fr; }
}

/* MODAL */
.modal-custom {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    justify-content: center;
    align-items: center;
    background-color: rgba(0,0,0,0.6);
    z-index: 9999;
}


.modal-content {
    background: #1f1f1f;
    color: #fff;
    padding: 25px;
    border-radius: 16px;
    max-width: 420px;
    width: 90%;
    text-align: center;
    position: relative;
}
.modal-img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    margin-bottom: 15px;
    border-radius: 10px;
}
.close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    cursor: pointer;
    color: #d4af37;
}
.modal-buttons {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    gap: 10px;
}
.modal-nome {
    font-size: 1.6rem;
    font-weight: bold;
    margin-bottom: 15px;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255,215,0,0.5);
}
.modal-info p {
    font-size: 1rem;
    margin: 6px 0;
    color: #ddd;
    transition: color 0.3s ease;
}
.modal-info p:hover {
    color: #ffd700;
}

/* BOT√ïES */
.btn-modern {
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.btn-edit { background: #fbc531; color: #111; }
.btn-edit:hover { background: #ffd700; }
.btn-delete { background: #e84118; color: #fff; }
.btn-delete:hover { background: #ff5e3a; }
.btn-close { background: #718093; color: #fff; }
.btn-close:hover { background: #95a5a6; }

.modal-info input,
.modal-info select,
.modal-info textarea {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #444;
    background: #222;
    color: #f5f5f5;
    font-size: 0.95rem;
    transition: all 0.2s ease;
}
.modal-info input:focus,
.modal-info select:focus,
.modal-info textarea:focus {
    border-color: #ffd700;
    outline: none;
    box-shadow: 0 0 6px rgba(255,215,0,0.5);
}
.modal-info label {
    letter-spacing: 0.5px;
}

/* PAGINA√á√ÉO */
.pagination-container .page-link {
    display: inline-block;
    padding: 8px 12px;
    border-radius: 8px;
    background: #111;
    color: #ffd700;
    font-weight: bold;
    text-decoration: none;
    transition: all 0.2s ease;
    min-width: 36px;
    text-align: center;
}
.pagination-container .page-link:hover {
    background: #1f1f1f;
    color: #d4af37;
    box-shadow: 0 2px 6px rgba(255,215,0,0.4);
}
.pagination-container .page-link.active {
    background: #d4af37;
    color: #111;
    box-shadow: 0 2px 8px rgba(212,175,55,0.6);
}
.pagination-container .page-link.disabled {
    background: #222;
    color: #555;
    cursor: default;
}

.modal-custom {
  display: none;
  position: fixed;
  z-index: 99999;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #2d2d2d;
  border: 2px solid #d4af37;
  border-radius: 12px;
  color: #f5f5f5;
  padding: 20px;
  width: 420px;
  box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
  animation: fadeIn 0.3s ease-in-out;
}

.modal-content input,
.modal-content select {
  background: #3b3b3b;
  border: 1px solid #d4af37;
  border-radius: 6px;
  color: white;
  padding: 6px;
  width: 100%;
}

.btn-modern {
  background: #d4af37;
  color: #1e1e1e;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}
.btn-modern:hover { background: #b9972f; }

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

#feedbackModal {
  display: none !important;
}

/* For√ßa o fundo escuro do modal de feedback */
#feedbackModal {
  background-color: rgba(0, 0, 0, 0.6);
}

#feedbackModal .modal-dialog {
  z-index: 2000; /* sobrep√µe tudo */
}

    #feedbackToast {
  min-width: 300px;
  font-size: 1.1rem;
  text-align: center;
}


</style>

<h2 class="titulo-estoque">Hist√≥rico de Produtos</h2>


<!-- FILTROS -->
<form method="get" style="margin-bottom: 25px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
    <input type="text" name="busca" value="{{ busca }}" placeholder="Buscar por nome ou c√≥digo"
           style="padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 260px;">
    <select name="categoria" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
        <option value="">Todas as categorias</option>
        {% for cat in categorias %}
            <option value="{{ cat.id }}" {% if categoria_id == cat.id|stringformat:"s" %}selected{% endif %}>
                {{ cat.nome_categoria }}
            </option>
        {% endfor %}
    </select>
    <button type="submit" style="padding: 8px 16px; background: #d4af37; color: #000; border: none; border-radius: 6px; font-weight: bold;">
        Aplicar filtro
    </button>
</form>

{% if despesas_vazias and not request.user.is_authenticated %}
<div style="display:flex; justify-content:flex-end; margin-bottom: 20px; gap:10px; position: relative; z-index: 10;">
    <button class="btn-modern btn-edit" id="btnCriarUsuarioPadrao">üë§ Criar Usu√°rio Admin Inicial</button>
</div>
{% endif %}

{% if request.user.is_staff %}
<div style="display:flex; justify-content:flex-end; margin-bottom: 20px; gap:10px; position: relative; z-index: 10;">
    <button class="btn-modern btn-edit" onclick="gerarBackup()">üíæ Gerar Backup Inicial</button>
</div>
{% endif %}

<div style="display:flex; justify-content:flex-end; margin-bottom: 20px; position: relative; z-index: 10;">
    <button class="btn-modern btn-edit" onclick="abrirModalCadastro()">‚ûï Novo Produto</button>
</div>



<!-- LISTA DE PRODUTOS -->
<div class="produtos-grid">
  {% for produto in produtos %}
  <div class="produto-card"
     onclick="abrirModalProduto(this)"
     data-id="{{ produto.id }}"
     data-nome="{{ produto.nome_produto }}"
     data-codigo="{{ produto.codigo|default:'' }}"
     data-categoria="{{ produto.categoria.nome_categoria }}"
    data-preco-venda="{{ produto.preco_venda|default_if_none:0|stringformat:'.2f'|cut:',' }}"
    data-preco-fornecedor="{{ produto.preco_fornecedor|default_if_none:0|stringformat:'.2f'|cut:',' }}"
     data-ganho-potencial="{{ produto.ganho_potencial|default_if_none:0 }}">
      <img class="produto-img"
           src="{% if produto.imagem %}{{ produto.imagem.url }}{% else %}{% static 'img/sem-imagem.png' %}{% endif %}"
           alt="{{ produto.nome_produto }}">
      <div class="produto-info">
          <h5>{{ produto.nome_produto }}</h5>
    <div class="info-item"><span class="label">C√≥digo</span><span class="value">{{ produto.codigo }}</span></div>
    <div class="info-item"><span class="label">Categoria</span><span class="value">{{ produto.categoria.nome_categoria }}</span></div>
    <div class="info-item"><span class="label">Venda</span><span class="value">R$ {{ produto.preco_venda|floatformat:2 }}</span></div>
    <div class="info-item"><span class="label">Fornecedor</span><span class="value">R$ {{ produto.preco_fornecedor|default_if_none:0|floatformat:2 }}</span></div>
    <div class="info-item"><span class="label">Ganho Potencial</span><span class="value">R$ {{ produto.ganho_potencial|default_if_none:0|floatformat:2 }}</span></div>
      </div>
  </div>
  {% empty %}
  <p style="grid-column: 1 / -1; text-align: center; color:#aaa;">Nenhum produto encontrado.</p>
  {% endfor %}
</div>

<!-- PAGINA√á√ÉO -->
{% if produtos.has_other_pages %}
<div class="pagination-container" style="display:flex; justify-content:center; margin:30px 0;">
    <ul class="pagination" style="display:flex; list-style:none; gap:8px; padding:0;">
        {% if produtos.has_previous %}
            <li><a href="?busca={{ busca }}&categoria={{ categoria_id }}&page={{ produtos.previous_page_number }}" class="page-link">&laquo;</a></li>
        {% else %}
            <li><span class="page-link disabled">&laquo;</span></li>
        {% endif %}

        {% for num in produtos.paginator.page_range %}
            {% if produtos.number == num %}
                <li><span class="page-link active">{{ num }}</span></li>
            {% else %}
                <li><a href="?busca={{ busca }}&categoria={{ categoria_id }}&page={{ num }}" class="page-link">{{ num }}</a></li>
            {% endif %}
        {% endfor %}

        {% if produtos.has_next %}
            <li><a href="?busca={{ busca }}&categoria={{ categoria_id }}&page={{ produtos.next_page_number }}" class="page-link">&raquo;</a></li>
        {% else %}
            <li><span class="page-link disabled">&raquo;</span></li>
        {% endif %}
    </ul>
</div>
{% endif %}


<!-- MODAL CADASTRO -->
<div id="modalCadastroProduto" class="modal-custom">
    <div class="modal-content" style="max-width:500px; width:90%; padding:30px; background:#1a1a1a; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.6);">
        <span class="close" onclick="document.getElementById('modalCadastroProduto').style.display='none'">&times;</span>
        <h3 class="modal-nome" style="font-size:1.8rem; color:#ffd700; text-align:center; margin-bottom:20px;">Cadastrar Novo Produto</h3>

        <form id="formCadastroProduto" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-info" style="display:flex; flex-direction:column; gap:15px;">
                {% for field in form %}
                    <div style="display:flex; flex-direction:column;">
                        <label for="{{ field.id_for_label }}" style="font-weight:bold; font-size:0.9rem; color:#ccc; margin-bottom:4px;">
                            {{ field.label }}
                        </label>
                        {{ field }}
                        {% if field.errors %}
                            <span style="color:#e84118; font-size:0.8rem;">{{ field.errors }}</span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <div class="modal-buttons" style="margin-top:25px; display:flex; justify-content:center; gap:12px;">
                <button type="submit" class="btn-modern btn-edit" style="flex:1; padding:10px; font-size:1rem;">üíæ Salvar</button>
                <button type="button" class="btn-modern btn-close" style="flex:1; padding:10px; font-size:1rem;" onclick="document.getElementById('modalCadastroProduto').style.display='none'">Cancelar</button>
            </div>
        </form>
    </div>
</div>


<div id="modalProduto" class="modal-custom">
  <div class="modal-content">
    {% csrf_token %} <span class="close" onclick="fecharModalProduto()">&times;</span>

    <h3 id="modalTitulo" class="modal-nome">üì¶ Detalhes do Produto</h3>


<!-- Toast container centralizado -->
<div class="position-fixed start-50 top-50 translate-middle" style="z-index: 1055">
  <div id="feedbackToast" class="toast align-items-center text-white bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div id="toastIcon" class="toast-body"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

    <form id="formEditarProduto" enctype="multipart/form-data" style="display:flex; flex-direction:column; gap:15px;">
      <input type="hidden" id="produtoId" name="id">

      <div class="modal-info" style="display:flex; flex-direction:column; gap:10px;">


        <div class="campo-staff" style="display:flex; flex-direction:column; gap:10px;">
          <div style="display:flex; flex-direction:column;">
            <label for="produtoCodigo" style="font-weight:bold; font-size:0.9rem; color:#ccc; margin-bottom:4px;">C√≥digo</label>
            <input type="text" id="produtoCodigo" name="codigo" disabled>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="produtoNome" style="font-weight:bold; font-size:0.9rem; color:#ccc; margin-bottom:4px;">Nome</label>
            <input type="text" id="produtoNome" name="nome_produto" disabled>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="produtoPrecoVenda" style="font-weight:bold; font-size:0.9rem; color:#ccc; margin-bottom:4px;">Pre√ßo de Venda (R$)</label>
            <input type="number" step="0.01" id="produtoPrecoVenda" name="preco_venda" disabled>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="produtoCategoriaSelect" style="font-weight:bold; font-size:0.9rem; color:#ccc; margin-bottom:4px;">Categoria</label>
            <select id="produtoCategoriaSelect" name="categoria" disabled>
                </select>
          </div>
        </div>


        <div class="campo-comum" style="display:flex; flex-direction:column; gap:10px;">
          <div style="display:flex; flex-direction:column;">
            <label for="produtoPrecoFornecedor" style="font-weight:bold; font-size:0.9rem; color:#ccc; margin-bottom:4px;">Pre√ßo Fornecedor (R$)</label>
            <input type="number" step="0.01" id="produtoPrecoFornecedor" name="preco_fornecedor" disabled>
          </div>

          <div style="display:flex; flex-direction:column;">
            <label style="font-weight:bold; font-size:0.9rem; color:#ccc; margin-bottom:4px;">Imagem Atual</label>
            <img id="previewImagem" src="" style="max-width:100px; border-radius:8px; margin-bottom: 5px;">
            <input type="file" id="produtoImagemInput" name="imagem" style="display:none;">
          </div>
        </div>
      </div>

      <div class="modal-buttons" style="margin-top:15px;">
        <button type="button" id="btnEditarProduto" class="btn-modern btn-edit">‚úèÔ∏è Editar</button>
        <button type="submit" id="btnSalvarProduto" class="btn-modern btn-save" style="display:none;">üíæ Salvar</button>
        <button type="button" class="btn-modern btn-close" onclick="fecharModalProduto()">Fechar</button>
      </div>
    </form>
  </div>
</div>




<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

let produtoOriginal = {};
let editando = false;

// Fun√ß√£o auxiliar para obter CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie("csrftoken");

function abrirModalProduto(card) {
    fecharModalProduto();
    const modal = document.getElementById("modalProduto");

    // Pega dados do card
    const id = card.dataset.id || "";
    const codigo = card.dataset.codigo || "";
    const nome = card.dataset.nome || "";
    const precoVenda = parseFloat(card.dataset.precoVenda) || 0;
    const precoFornecedor = parseFloat(card.dataset.precoFornecedor) || 0;
    const categoriaNome = card.dataset.categoria || "";
    const img = card.dataset.img || "";

    // Preenche campos
    document.getElementById("produtoId").value = id;
    document.getElementById("produtoCodigo").value = codigo;
    document.getElementById("produtoNome").value = nome;
    document.getElementById("produtoPrecoVenda").value = precoVenda.toFixed(2);
    document.getElementById("produtoPrecoFornecedor").value = precoFornecedor.toFixed(2);
    document.getElementById("previewImagem").src = img;

    // Popula select de categorias
    const selectCategoria = document.getElementById("produtoCategoriaSelect");
    selectCategoria.innerHTML = "";
    const categorias = [
        {% for cat in categorias %}
        { id: "{{ cat.id }}", nome: "{{ cat.nome_categoria }}" },
        {% endfor %}
    ];
    categorias.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat.id;
        option.textContent = cat.nome;
        if (cat.nome === categoriaNome || String(cat.id) === String(card.dataset.categoriaId)) {
            option.selected = true;
        }
        selectCategoria.appendChild(option);
    });

    // Guarda valores originais
    produtoOriginal = {
        codigo,
        nome_produto: nome,
        preco_venda: precoVenda,
        preco_fornecedor: precoFornecedor,
        categoria: selectCategoria.value,
        img
    };

    // Desabilita campos (modo visualiza√ß√£o)
    document.querySelectorAll("#formEditarProduto input:not([type='hidden']), #formEditarProduto select")
        .forEach(c => c.disabled = true);

    document.getElementById("produtoImagemInput").style.display = "none";
    document.getElementById("btnEditarProduto").style.display = "inline-block";
    document.getElementById("btnSalvarProduto").style.display = "none";
    document.getElementById("modalTitulo").textContent = "üì¶ Detalhes do Produto";
    modal.style.display = "flex";
}

// ===== BOT√ÉO EDITAR =====
document.getElementById("btnEditarProduto").addEventListener("click", () => {
    editando = true;
    const campos = document.querySelectorAll("#formEditarProduto input:not([type='hidden']), #formEditarProduto select");
    campos.forEach(c => {
        if (c.id !== "produtoId") c.disabled = false;
    });

    document.getElementById("produtoImagemInput").style.display = "block";
    document.getElementById("btnEditarProduto").style.display = "none";
    document.getElementById("btnSalvarProduto").style.display = "inline-block";
    document.getElementById("modalTitulo").textContent = "‚úèÔ∏è Editando Produto";
});

// ===== FORM SALVAR =====
document.getElementById("formEditarProduto").addEventListener("submit", (e) => {
    e.preventDefault();

    const campos = document.querySelectorAll("#formEditarProduto input:not([type='hidden']), #formEditarProduto select");
    campos.forEach(c => c.disabled = false);

    const formData = new FormData(e.target);
    const produtoId = document.getElementById("produtoId").value;

    // Garante valores num√©ricos padr√£o
    if (!formData.get("preco_venda")) formData.set("preco_venda", "0");
    if (!formData.get("preco_fornecedor")) formData.set("preco_fornecedor", "0");

    // Valida√ß√£o: fornecedor n√£o pode ser >= venda
    const precoVenda = parseFloat(formData.get("preco_venda")) || 0;
    const precoFornecedor = parseFloat(formData.get("preco_fornecedor")) || 0;

    if (precoFornecedor >= precoVenda) {
        mostrarFeedback({
            tipo: "erro",
            titulo: "Erro de Valida√ß√£o",
            mensagem: "‚ö†Ô∏è O pre√ßo do fornecedor n√£o pode ser maior ou igual ao pre√ßo de venda."
        });
        return;
    }

    // Verifica altera√ß√µes
    let mudou = false;
    for (const [key, value] of formData.entries()) {
        if (key === "imagem") {
            if (value instanceof File && value.name) mudou = true;
        } else if (produtoOriginal.hasOwnProperty(key)) {
            if (String(value || "0") !== String(produtoOriginal[key] || "0")) {
                mudou = true;
            }
        }
    }

    if (!mudou) {
        mostrarFeedback({
            tipo: "erro",
            titulo: "Sem altera√ß√µes",
            mensagem: "‚ö†Ô∏è Nenhuma altera√ß√£o detectada."
        });
        campos.forEach(c => c.disabled = true);
        return;
    }

    // Envia via fetch
    fetch(`/produto/${produtoId}/editar/`, {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": csrftoken }
    })
    .then(res => res.json())
    .then(resp => {
            if (resp.sucesso) {
        mostrarFeedback({
            tipo: "sucesso",
            titulo: "Produto Atualizado",
            mensagem: "‚úÖ Produto atualizado com sucesso!"
        });
        setTimeout(() => location.reload(), 2500);
    } else {
            const msg = resp.erros || resp.erro || "Erro desconhecido.";
            mostrarFeedback({
                tipo: "erro",
                titulo: "Erro ao Salvar",
                mensagem: "‚ùå " + msg
            });
        }
    })
    .catch(err => {
        console.error(err);
        mostrarFeedback({
            tipo: "erro",
            titulo: "Erro de Conex√£o",
            mensagem: "‚ùå N√£o foi poss√≠vel conectar ao servidor."
        });
    });
});


// ===== FECHAR MODAL =====
function fecharModalProduto() {
    const modal = document.getElementById("modalProduto");
    if (modal.style.display === "flex") {
        editando = false;
        const campos = document.querySelectorAll("#formEditarProduto input:not([type='hidden']), #formEditarProduto select");
        campos.forEach(c => c.disabled = true);
        document.getElementById("produtoImagemInput").style.display = "none";
        document.getElementById("produtoImagemInput").value = "";
        document.getElementById("btnEditarProduto").style.display = "inline-block";
        document.getElementById("btnSalvarProduto").style.display = "none";
        document.getElementById("modalTitulo").textContent = "üì¶ Detalhes do Produto";
        modal.style.display = "none";
    }
}

// ... (Resto do seu JavaScript: modal cadastro, backup, usu√°rio padr√£o) ...
// (MANTENHA O RESTO DO SEU C√ìDIGO JS ORIGINAL A PARTIR DAQUI)


// ======= MODAL CADASTRO (mant√©m igual) =======
function abrirModalCadastro() {
  document.getElementById('modalCadastroProduto').style.display = 'flex';
}

window.onclick = function(event) {
  const modal = document.getElementById('modalCadastroProduto');
  if (event.target == modal) modal.style.display = "none";
};

// ======= FORM CADASTRO PRODUTO =======
document.getElementById('formCadastroProduto').addEventListener('submit', function(e){
  e.preventDefault();
  const formData = new FormData(this);
  fetch("{% url 'cadastrar_produto' %}", {
      method: "POST",
      headers: {'X-CSRFToken': '{{ csrf_token }}'},
      body: formData
  })
  .then(res => res.json())
  .then(data => {
      if(data.success){
          alert("Produto cadastrado com sucesso!");
          location.reload();
      } else {
          alert("Erro: " + (data.error || "Verifique os campos."));
      }
  })
  .catch(err => alert("Erro: " + err));
});

// ======= GERAR BACKUP =======
function gerarBackup() {
  if (!confirm("Deseja realmente gerar o backup de categorias e produtos?")) return;
  fetch("{% url 'gerar_backup' %}", {
      method: "POST",
      headers: {"X-CSRFToken": "{{ csrf_token }}","Content-Type": "application/json"},
      body: JSON.stringify({})
  })
  .then(res => res.json())
  .then(data => {
      if(data.success){
          alert("Backup gerado com sucesso!");
          location.reload();
      } else {
          alert("Erro ao gerar backup: " + (data.error || "Verifique o console."));
      }
  })
  .catch(err => alert("Erro: " + err));
}

// ======= CRIAR USU√ÅRIO PADR√ÉO =======
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('btnCriarUsuarioPadrao');
  if(btn) {
      btn.addEventListener('click', function() {
          if(confirm("Deseja realmente criar o usu√°rio padr√£o admin123?")) {
              fetch("{% url 'criar_usuario_padrao' %}", {
                  method: "POST",
                  headers: {"X-CSRFToken": "{{ csrf_token }}"},
              })
              .then(res => res.json())
              .then(data => {
                  alert(data.message);
                  if(data.success) location.reload();
              })
              .catch(err => alert("Erro: " + err));
          }
      });
  }
});

function mostrarFeedback({ tipo, titulo, mensagem }) {
    const toastEl = document.getElementById("feedbackToast");
    const toastIcon = document.getElementById("toastIcon");

    toastIcon.innerHTML = `${tipo === "sucesso" ? "‚úÖ" : "‚ùå"} <strong>${titulo}</strong><br>${mensagem}`;

    const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
    toast.show();
}



</script>


{% endblock %}
